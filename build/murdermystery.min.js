/*! murdermystery 2015-01-24 / www.burningtomato.com */
!function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}();var Settings={tileSize:32},Direction={UP:1,LEFT:2,DOWN:3,RIGHT:4},Entity=Class.extend({posX:0,posY:0,height:0,width:0,sprite:null,spriteShadow:null,spriteHurt:null,velocityX:0,velocityY:0,movementSpeed:2,direction:0,headBobTimer:0,headBob:0,weapon:null,healthValue:6,healthCapacity:12,dead:!1,hurtTimer:0,causesCollision:!0,receivesDamage:!0,causesDamage:!1,init:function(){this.width=32,this.height=32,this.direction=Direction.DOWN},generateHurtSprite:function(){this.spriteHurt=this.sprite;var a=function(){this.spriteHurt=Gfx.makeHurtSprite(this.sprite)}.bind(this);this.sprite.onload=a,this.sprite.complete&&a()},damage:function(a){!this.dead&&this.receivesDamage&&(a>0?this.hurtTimer=1:0>a&&(this.hurtTimer=0),this.drewHurtFrame=!1,this.healthValue-=a,this.healthValue<=0?(this.healthValue=0,this.die()):a>0&&this.sfxHurt())},die:function(){!this.dead&&this.receivesDamage&&(this.dead=!0,this.weapon=null,this.sfxDie())},sfxHurt:function(){Sfx.play("enemy_hurt.wav")},sfxDie:function(){Sfx.play("goblin_death.wav")},setPos:function(a,b){this.posX=a,this.posY=b},setCoord:function(a,b){this.posX=Settings.tileSize*a+(Settings.tileSize/2-this.width/2),this.posY=Settings.tileSize*b+(Settings.tileSize/2-this.height/2)},getPos:function(){return{x:this.posX,y:this.posY}},canMoveLeft:function(){var a=this.posX-this.movementSpeed,b=this.getRect(a,null);return!Game.map.isRectBlocked(b,this.isNpc,this)},canMoveRight:function(){var a=this.posX+this.movementSpeed,b=this.getRect(a,null);return!Game.map.isRectBlocked(b,this.isNpc,this)},canMoveUp:function(){var a=this.posY-this.movementSpeed,b=this.getRect(null,a);return!Game.map.isRectBlocked(b,this.isNpc,this)},canMoveDown:function(){var a=this.posY+this.movementSpeed,b=this.getRect(null,a);return!Game.map.isRectBlocked(b,this.isNpc,this)},isAttacking:!1,attackTimer:0,attack:function(){if(!this.isAttacking){this.isAttacking=!0,this.attackTimer=10,null!=this.weapon&&this.weapon.playSfx();for(var a=this.getAttackRadius(),b=Game.map.getEntitiesInRect(a,this),c=0;c<b.length;c++){var d=b[c];d.receivesDamage&&!d.dead&&d.damage(null==this.weapon?0:this.weapon.damage)}}},drewHurtFrame:!1,draw:function(a){switch(a.save(),a.translate(Camera.translateX(this.posX),Camera.translateY(this.posY)),this.direction){case Direction.UP:break;case Direction.RIGHT:a.rotate(90*Math.PI/180),a.translate(-this.height/2,-this.width+this.width/4);break;case Direction.DOWN:a.rotate(180*Math.PI/180),a.translate(-this.width,-this.height);break;case Direction.LEFT:a.rotate(270*Math.PI/180),a.translate(-this.width+this.width/4,this.height/2)}if(null!=this.weapon&&this.weapon.draw(this,a),null!=this.spriteShadow&&a.drawImage(this.spriteShadow,0,0,this.width,this.height,1,1,this.width,this.height),null!=this.sprite&&(this.hurtTimer>0?(a.drawImage(this.spriteHurt,0,0,this.width,this.height,this.headBob,0,this.width,this.height),this.drewHurtFrame=!0):this.sprite.isAnimation?this.sprite.draw(a,this.headBob,0):a.drawImage(this.sprite,0,0,this.width,this.height,this.headBob,0,this.width,this.height)),a.restore(),Settings.drawCollisions){var b=this.getRect();if(a.beginPath(),a.rect(Camera.translateX(b.left),Camera.translateY(b.top),b.width,b.height),a.strokeStyle="#FFCCAA",a.stroke(),a.closePath(),this.isAttacking){var b=this.getAttackRadius();a.beginPath(),a.rect(Camera.translateX(b.left),Camera.translateY(b.top),b.width,b.height),a.strokeStyle="#AACCFF",a.stroke(),a.closePath()}}},update:function(){this.hurtTimer>0&&this.drewHurtFrame&&this.hurtTimer--,this.dead||(this.velocityX<0&&(!this.canMoveLeft()||this.isAttacking)&&(this.velocityX=0),this.velocityX>0&&(!this.canMoveRight()||this.isAttacking)&&(this.velocityX=0),this.velocityY<0&&(!this.canMoveUp()||this.isAttacking)&&(this.velocityY=0),this.velocityY>0&&(!this.canMoveDown()||this.isAttacking)&&(this.velocityY=0),this.posX+=this.velocityX,this.posY+=this.velocityY,0!=this.velocityX||0!=this.velocityY?(this.headBobTimer>0&&this.headBobTimer--,this.headBobTimer<=0&&(this.headBob=1==this.headBob?-1:1,this.headBobTimer=15)):this.headBob=0,null!=this.weapon?(this.weapon.update(this),this.attackTimer>0&&(this.weapon.swordSway=this.attackTimer,this.attackTimer--,this.attackTimer<=0&&(this.isAttacking=!1))):this.isAttacking=!1,this.sprite.isAnimation&&this.sprite.update())},getRect:function(a,b){var c=this.posX,d=this.posY;null!=a&&(c=a),null!=b&&(d=b);var e=6,f={left:c+e/2,top:d+e/2,height:this.height-e,width:this.width-e};return f.bottom=f.top+f.height,f.right=f.left+f.width,f},getAttackRadius:function(){var a=this.getRect(),b=null==this.weapon?10:this.weapon.height,c=null==this.weapon?10:this.weapon.width,d=6;switch(this.direction){default:case Direction.DOWN:a.top+=this.height-d,a.height=b,a.width=c,a.left+=this.width/2;break;case Direction.UP:a.top-=this.height,a.height=b,a.width=c;break;case Direction.LEFT:a.height=c,a.width=b,a.left-=a.width/2,a.top+=d;break;case Direction.RIGHT:a.height=c,a.width=b,a.left+=a.width,a.top-=d}return a.bottom=a.top+a.height,a.right=a.left+a.width,a}});$(document).ready(function(){console.log(" __  __               _           __  __           _"),console.log("|  \\/  |             | |         |  \\/  |         | |"),console.log("| \\  / |_   _ _ __ __| | ___ _ __| \\  / |_   _ ___| |_ ___ _ __ _   _"),console.log("| |\\/| | | | | '__/ _` |/ _ \\ '__| |\\/| | | | / __| __/ _ \\ '__| | | |"),console.log("| |  | | |_| | | | (_| |  __/ |  | |  | | |_| \\__ \\ ||  __/ |  | |_| |"),console.log("|_|  |_|\\__,_|_|  \\__,_|\\___|_|  |_|  |_|\\__, |___/\\__\\___|_|   \\__, |"),console.log("                                          __/ |                  __/ |"),console.log("                                         |___/                  |___/ "),console.log('   "Wow. Much murder. Very mystery."'),console.log(""),Game.initialize(),Sfx.preload(),Gfx.preload();var a=function(){Game.start()};Settings.skipBootLogo?a():BootLogo.show(a)});var Game={map:null,maps:[],lastMapId:null,initialize:function(){Canvas.initialize(),Keyboard.bind()},start:function(){Canvas.$canvas.hide(),this.maps=[],this.lastMapId=null,Inventory.clear(),this.loadMap("dungeon_1")},resetting:!1,reset:function(a){if(null==a&&(a=function(){}),!this.resetting){this.resetting=!0,Dialogue.hide(),$("#hud").hide(),null!=this.map&&this.map.pause();var b=function(){this.map=null,this.start(),this.resetting=!1}.bind(this);Canvas.$canvas.fadeOut(3e3,function(){Music.stopAll(),window.setTimeout(b,1e3)})}},loadMap:function(a){var b=function(){Canvas.$canvas.delay(200).fadeIn(null==this.lastMapId?2e3:"fast"),this.lastMapId=a}.bind(this),c=function(){"undefined"==typeof this.maps[a]?(this.map=new Map,this.maps[a]=this.map,this.map.load(a,function(a){return a?(this.map.paused||$("#hud").show(),void b()):void alert("Something went wrong, could not load the next part of the game. Sorry... we let you down.")}.bind(this))):(this.map=this.maps[a],this.map.redeploy(),b())}.bind(this);Canvas.$canvas.is(":visible")?Canvas.$canvas.fadeOut("fast",c):c()},draw:function(a){null!=this.map&&this.map.draw(a)},update:function(){null!=this.map&&this.map.update(),Dialogue.update(),Keyboard.update(),Camera.update()}},Keyboard={downNow:[],downLast:[],clear:function(){Keyboard.downNow=[],Keyboard.downLast=[]},bind:function(){Keyboard.clear(),$(window).keyup(function(a){Keyboard.releaseKey(a.keyCode)}),$(window).keydown(function(a){Keyboard.pressKey(a.keyCode)})},update:function(){Keyboard.downLast=Keyboard.downNow.slice(0)},pressKey:function(a){-1===Keyboard.downNow.indexOf(a)&&Keyboard.downNow.push(a)},releaseKey:function(a){var b=Keyboard.downNow.indexOf(a);b>-1&&Keyboard.downNow.splice(b,1)},isKeyDown:function(a){return Keyboard.downNow.indexOf(a)>=0},wasKeyDown:function(a){return Keyboard.downLast.indexOf(a)>=0},wasKeyPressed:function(a){return Keyboard.isKeyDown(a)&&!Keyboard.wasKeyDown(a)}};if("undefined"==typeof KeyEvent)var KeyEvent={DOM_VK_CANCEL:3,DOM_VK_HELP:6,DOM_VK_BACK_SPACE:8,DOM_VK_TAB:9,DOM_VK_CLEAR:12,DOM_VK_RETURN:13,DOM_VK_ENTER:14,DOM_VK_SHIFT:16,DOM_VK_CONTROL:17,DOM_VK_ALT:18,DOM_VK_PAUSE:19,DOM_VK_CAPS_LOCK:20,DOM_VK_ESCAPE:27,DOM_VK_SPACE:32,DOM_VK_PAGE_UP:33,DOM_VK_PAGE_DOWN:34,DOM_VK_END:35,DOM_VK_HOME:36,DOM_VK_LEFT:37,DOM_VK_UP:38,DOM_VK_RIGHT:39,DOM_VK_DOWN:40,DOM_VK_PRINTSCREEN:44,DOM_VK_INSERT:45,DOM_VK_DELETE:46,DOM_VK_0:48,DOM_VK_1:49,DOM_VK_2:50,DOM_VK_3:51,DOM_VK_4:52,DOM_VK_5:53,DOM_VK_6:54,DOM_VK_7:55,DOM_VK_8:56,DOM_VK_9:57,DOM_VK_SEMICOLON:59,DOM_VK_EQUALS:61,DOM_VK_A:65,DOM_VK_B:66,DOM_VK_C:67,DOM_VK_D:68,DOM_VK_E:69,DOM_VK_F:70,DOM_VK_G:71,DOM_VK_H:72,DOM_VK_I:73,DOM_VK_J:74,DOM_VK_K:75,DOM_VK_L:76,DOM_VK_M:77,DOM_VK_N:78,DOM_VK_O:79,DOM_VK_P:80,DOM_VK_Q:81,DOM_VK_R:82,DOM_VK_S:83,DOM_VK_T:84,DOM_VK_U:85,DOM_VK_V:86,DOM_VK_W:87,DOM_VK_X:88,DOM_VK_Y:89,DOM_VK_Z:90,DOM_VK_CONTEXT_MENU:93,DOM_VK_NUMPAD0:96,DOM_VK_NUMPAD1:97,DOM_VK_NUMPAD2:98,DOM_VK_NUMPAD3:99,DOM_VK_NUMPAD4:100,DOM_VK_NUMPAD5:101,DOM_VK_NUMPAD6:102,DOM_VK_NUMPAD7:103,DOM_VK_NUMPAD8:104,DOM_VK_NUMPAD9:105,DOM_VK_MULTIPLY:106,DOM_VK_ADD:107,DOM_VK_SEPARATOR:108,DOM_VK_SUBTRACT:109,DOM_VK_DECIMAL:110,DOM_VK_DIVIDE:111,DOM_VK_F1:112,DOM_VK_F2:113,DOM_VK_F3:114,DOM_VK_F4:115,DOM_VK_F5:116,DOM_VK_F6:117,DOM_VK_F7:118,DOM_VK_F8:119,DOM_VK_F9:120,DOM_VK_F10:121,DOM_VK_F11:122,DOM_VK_F12:123,DOM_VK_F13:124,DOM_VK_F14:125,DOM_VK_F15:126,DOM_VK_F16:127,DOM_VK_F17:128,DOM_VK_F18:129,DOM_VK_F19:130,DOM_VK_F20:131,DOM_VK_F21:132,DOM_VK_F22:133,DOM_VK_F23:134,DOM_VK_F24:135,DOM_VK_NUM_LOCK:144,DOM_VK_SCROLL_LOCK:145,DOM_VK_COMMA:188,DOM_VK_PERIOD:190,DOM_VK_SLASH:191,DOM_VK_BACK_QUOTE:192,DOM_VK_OPEN_BRACKET:219,DOM_VK_BACK_SLASH:220,DOM_VK_CLOSE_BRACKET:221,DOM_VK_QUOTE:222,DOM_VK_META:224};var Music={sounds:{},prepareSound:function(a){return"undefined"==typeof this.sounds[a]&&(this.sounds[a]=new Audio("assets/audio/"+a)),this.sounds[a]},loopSound:function(a){var b=this.prepareSound(a);b.currentTime=0,b.addEventListener("ended",function(){this.currentTime=0,this.load(),this.play()}),b.load(),b.play()},stopSound:function(a){var b=this.prepareSound(a);b.pause()},stopAll:function(){for(var a in this.sounds){var b=this.sounds[a];b.pause()}}},Sfx={sounds:{},preload:function(){},load:function(a){return"undefined"!=typeof Sfx.sounds[a]?Sfx.sounds[a]:(Sfx.sounds[a]=new Audio("assets/sfx/"+a),Sfx.sounds[a].load(),Sfx.sounds[a])},play:function(a){"undefined"==typeof Sfx.sounds[a]?Sfx.load(a):Sfx.sounds[a].load(),Sfx.sounds[a].play()}},Utils={rectIntersects:function(a,b){return!(b.left>a.right||b.right<a.left||b.top>a.bottom||b.bottom<a.top)}},MathHelper={clamp:function(a,b,c){return b>a?b:a>c?c:a},lerp:function(a,b,c){return c=0>c?0:c,c=c>1?1:c,a+(b-a)*c}},Animation=Class.extend({sprite:null,width:0,height:0,index:0,animSpeed:0,animTimer:0,frameCount:0,loop:!1,done:!1,isAnimation:!0,init:function(a,b,c,d,e,f){this.sprite=Gfx.load(a),this.width=b,this.height=c,this.index=0,this.animSpeed=d,this.animTimer=d,this.frameCount=e,this.loop=!!f,this.done=!1},update:function(){this.animTimer>0&&!this.done&&(this.animTimer--,this.animTimer<=0&&(this.index++,this.index>=this.frameCount&&(this.loop?this.index=0:(this.done=!0,this.index--)),this.animTimer=this.animSpeed))},draw:function(a,b,c){a.drawImage(this.sprite,this.width*this.index,0,this.width,this.height,b,c,this.width,this.height)}}),Camera={x:0,y:0,applyX:0,applyY:0,yLocked:!1,xLocked:!1,translateX:function(a){return Math.round(a+this.applyX)},translateY:function(a){return Math.round(a+this.applyY)},translate:function(a,b){return{x:this.translateX(a),y:this.translateY(b)}},setPos:function(a,b){this.x=a,this.y=b},trackingEntity:null,centerToMap:function(){this.x=Canvas.canvas.width/2-Game.map.widthPx/2,this.y=Canvas.canvas.height/2-Game.map.heightPx/2,this.xLocked=Canvas.canvas.width>Game.map.widthPx,this.yLocked=Canvas.canvas.height>Game.map.heightPx,this.trackingEntity=null},trackHard:!1,followEntity:function(a,b){this.trackingEntity=a,this.trackHard=!!b},update:function(){if(null!=this.trackingEntity){if(!this.xLocked){var a=Canvas.canvas.width/2-this.trackingEntity.posX-this.trackingEntity.width/2,b=Game.map.widthPx-Canvas.canvas.width;this.x=MathHelper.clamp(a,-b,0)}if(!this.yLocked){var c=Canvas.canvas.height/2-this.trackingEntity.posY-this.trackingEntity.height/2,d=Game.map.heightPx-Canvas.canvas.height;this.y=MathHelper.clamp(c,-d,0)}}this.trackHard?(this.applyX=this.x,this.applyY=this.y,this.trackHard=!1):(this.applyX=MathHelper.lerp(this.applyX,this.x,.1),this.applyY=MathHelper.lerp(this.applyY,this.y,.1))}},Canvas={$canvas:null,canvas:null,context:null,lastRenderTime:null,fps:0,initialize:function(){console.info("[Canvas] Game is starting, starting loop."),this.$canvas=$("#game"),this.canvas=this.$canvas[0],this.context=this.canvas.getContext("2d"),console.info("[Canvas] Canvas render resolution is "+this.canvas.width+"x"+this.canvas.height+"."),this.canvas.mozImageSmoothingEnabled=!1,this.canvas.webkitImageSmoothingEnabled=!1,this.canvas.msImageSmoothingEnabled=!1,this.canvas.imageSmoothingEnabled=!1;var a=function(){if(window.requestAnimationFrame(a),Game.draw(this.context),Game.update(),Settings.countFps){if(null==this.lastRenderTime)return this.lastRenderTime=Date.now(),void(this.fps=0);var b=((new Date).getTime()-this.lastRenderTime)/1e3;this.lastRenderTime=Date.now(),this.fps=1/b}}.bind(this);Settings.countFps&&window.setInterval(function(){$("#fps").show().text("FPS: "+this.fps.toFixed(0))}.bind(this),1e3),a()}},Gfx={data:{},clear:function(){this.data={}},load:function(a){return a="assets/images/"+a+".png","undefined"==typeof this.data[a]&&(this.data[a]=new Image,this.data[a].src=a),this.data[a]},makeHurtSprite:function(a){var b=document.createElement("canvas"),c=b.getContext("2d");b.width=a.width,b.height=a.height,c.drawImage(a,0,0,a.width,a.height);for(var d=c.getImageData(0,0,a.width,a.height),e=d.data,f=[255,255,255],g=0;g<e.length;g+=4)e[g]=f[0],e[g+1]=f[1],e[g+2]=f[2];return d.data=e,c.putImageData(d,0,0),b},preload:function(){}},Container=Entity.extend({isContainer:!0,isEnemy:!1,isNpc:!0,causesDamage:!1,receivesDamage:!0,contents:[],healthCapacity:1,healthValue:1,spriteNormal:null,spriteDestroyed:null,init:function(){this.contents=[],this.spriteNormal=null,this.spriteDestroyed=null,this.spriteShadow=null},sfxHurt:function(){Sfx.play("damage_chest.wav")},die:function(){this.dead||(this.dead=!0,this.drewHurtFrame=!1,this.sprite=this.spriteDestroyed,this.sfxHurt(),this.open())},open:function(){return this.dead?void 0:void this.damage(this.healthCapacity)}}),Chest=Container.extend({init:function(){this._super(),this.spriteNormal=Gfx.load("chest_closed"),this.spriteDestroyed=Gfx.load("chest_open"),this.sprite=this.spriteNormal,this.width=48,this.height=32,this.generateHurtSprite()},damage:function(a){0===a&&a++,this._super(a)},open:function(){for(var a=Math.round(100*Math.random())+1,b=0;a>b;b++){var c=new Coin;do c.posX=this.posX+Math.round(100*Math.random()),c.posY=this.posY+Math.round(100*Math.random());while(Game.map.isRectBlocked(c.getRect(),!1));c.velocityX=3*Math.random(),c.velocityY=3*Math.random(),c.sprite.index=Math.round(Math.random()*c.sprite.frameCount),Game.map.add(c)}}}),Goblin=Entity.extend({isNpc:!0,causesDamage:!0,init:function(){this._super(),this.width=28,this.height=18,this.sprite=Gfx.load("goblin"),this.spriteShadow=Gfx.load("goblin_shadow"),this.setCoord(9,9),this.weapon=new SwordTroll,this.movementSpeed=1.5,this.generateHurtSprite()},deathDelayer:0,moveDirection:0,canContinue:!0,attentionSpan:0,restTimer:0,killMode:!1,damage:function(a){this.killMode=!0,this._super(a)},update:function(){if(this._super(),!this.dead){this.canContinue||(this.moveDirection=Math.round(3*Math.random())+1,this.attentionSpan=Math.round(300*Math.random()),this.canContinue=!0),this.attentionSpan>0&&this.attentionSpan--,this.attentionSpan<=0&&(this.canContinue=!1),this.restTimer>0&&this.restTimer--,this.velocityX=0,this.velocityY=0;var a=Game.map.player;if(this.killMode){var b=Math.abs(this.posX-a.posX),c=Math.abs(this.posY-a.posY);32>=b+c&&this.restTimer<=0&&!this.isAttacking&&(this.attack(),this.restTimer=30),0==this.restTimer&&(a.posY<this.posY&&c>16?(this.direction=Direction.UP,this.velocityY=-this.movementSpeed):a.posY>this.posY&&c>16&&(this.direction=Direction.DOWN,this.velocityY=+this.movementSpeed),a.posX<this.posX&&b>16?(this.direction=Direction.LEFT,this.velocityX=-this.movementSpeed):a.posX>this.posX&&b>16&&(this.direction=Direction.RIGHT,this.velocityX=+this.movementSpeed))}else{var b=Math.abs(this.posX-a.posX),c=Math.abs(this.posY-a.posY);if(255>=b+c&&(this.killMode=!0),this.canContinue&&this.attentionSpan>0&&this.restTimer<=0)switch(this.moveDirection){default:case Direction.UP:this.velocityY=-this.movementSpeed,this.direction=Direction.UP,this.canMoveUp()||(this.canContinue=!1);break;case Direction.DOWN:this.velocityY=+this.movementSpeed,this.direction=Direction.DOWN,this.canMoveDown()||(this.canContinue=!1);break;case Direction.LEFT:this.velocityX=-this.movementSpeed,this.direction=Direction.LEFT,this.canMoveLeft()||(this.canContinue=!1);break;case Direction.RIGHT:this.velocityX=+this.movementSpeed,this.direction=Direction.RIGHT,this.canMoveRight()||(this.canContinue=!1)}}this.canContinue||(this.restTimer=Math.round(100*Math.random()))}this.dead&&(this.hurtTimer=1/0,this.deathDelayer>0?(this.deathDelayer--,0==this.deathDelayer&&Game.map.remove(this)):this.drewHurtFrame&&(this.deathDelayer=3))}}),Player=Entity.extend({damageFlash:0,isTeleporting:!1,teleportTo:null,teleportTimer:0,isPlayer:!0,touchPainTimer:0,causesDamage:!1,init:function(){this._super(),this.width=32,this.height=18,this.sprite=Gfx.load("hero"),this.spriteShadow=Gfx.load("hero_shadow"),this.healthCapacity=12,this.weapon=Inventory.currentWeapon,this.healthValue=Inventory.health,this.syncHealthUi(),this.generateHurtSprite()},syncHealthUi:function(){var a=$("#health"),b=Math.ceil(this.healthCapacity/4),c=0;a.html("");for(var d=0;b>d;d++){var e=this.healthValue-c,f=e>4?4:e;c+=f,e=this.healthValue-c;{$("<img />").attr("src","assets/images/health_"+f+".png").addClass(f>0?"filled"+f:"empty").addClass(0==e?"last":"notlast").appendTo(a)}}},damage:function(a){this.isTeleporting||(a>0&&!this.dead&&(this.damageFlash=1,Sfx.play("player_hurt.wav")),this._super(a),this.syncHealthUi(),Inventory.health=this.healthValue)},die:function(){this.dead||(this._super(),this.damageFlash=1/0,Sfx.play("cinboom.wav"),Game.reset())},update:function(){var a=this.getRect();if(!this.isTeleporting&&!this.dead&&!this.isAttacking){if(Keyboard.isKeyDown(KeyEvent.DOM_VK_LEFT)||Keyboard.isKeyDown(KeyEvent.DOM_VK_A)?(this.velocityX=-this.movementSpeed,this.direction=Direction.LEFT):Keyboard.isKeyDown(KeyEvent.DOM_VK_RIGHT)||Keyboard.isKeyDown(KeyEvent.DOM_VK_D)?(this.velocityX=+this.movementSpeed,this.direction=Direction.RIGHT):this.velocityX=0,Keyboard.isKeyDown(KeyEvent.DOM_VK_UP)||Keyboard.isKeyDown(KeyEvent.DOM_VK_W)?(this.velocityY=-this.movementSpeed,this.direction=Direction.UP):Keyboard.isKeyDown(KeyEvent.DOM_VK_DOWN)||Keyboard.isKeyDown(KeyEvent.DOM_VK_S)?(this.velocityY=+this.movementSpeed,this.direction=Direction.DOWN):this.velocityY=0,Keyboard.wasKeyPressed(KeyEvent.DOM_VK_SPACE)&&this.attack(),this.damageFlash>0&&this.damageFlash--,this.hurtTimer<=0&&this.touchPainTimer<=0)for(var b=Game.map.entities,c=b.length,d=0;c>d;d++){var e=b[d];if(e.isNpc&&e.causesDamage&&!e.dead){var f=e.getRect();if(Utils.rectIntersects(f,a)){this.damage(1),this.touchPainTimer=30,this.hurtTimer++;break}}}else this.touchPainTimer>0&&this.touchPainTimer--;for(var b=Game.map.entities,c=b.length,d=0;c>d;d++){var e=b[d];if(e.isPickupable&&e.instantPickup){var f=e.getRect();Utils.rectIntersects(f,a)&&e.pickUp()}}}if(this.dead&&(this.damageFlash=1/0),this._super(),this.isTeleporting)this.damageFlash=0,this.teleportTimer>0&&(this.teleportTimer--,0==this.teleportTimer&&Game.loadMap(this.teleportTo));else{var g=Game.map.getTeleport(this.getRect());this.isTeleporting||null==g||(this.isTeleporting=!0,this.teleportTo=g,this.teleportTimer=30)}},sfxHurt:function(){Sfx.play("player_hurt.wav")},sfxDeath:function(){},draw:function(a){this.damageFlash>0&&(a.rect(0,0,Canvas.canvas.width,Canvas.canvas.height),a.fillStyle="#ff0000",a.fill()),this._super(a)}}),Pot=Container.extend({init:function(){this._super(),this.spriteNormal=Gfx.load("pot"),this.spriteDestroyed=Gfx.load("pot_shards"),this.sprite=this.spriteNormal,this.width=32,this.height=32,this.generateHurtSprite()},sfxHurt:function(){Sfx.play("break_pot.wav")},die:function(){this._super(),this.causesCollision=!1;for(var a=Math.round(3*Math.random())+1,b=0;a>b;b++){var c=new Coin;do c.posX=this.posX+Math.round(10*Math.random())-5,c.posY=this.posY+Math.round(10*Math.random())-5;while(Game.map.isRectBlocked(c.getRect(),!1,this));c.velocityX=3*Math.random(),c.velocityY=3*Math.random(),c.sprite.index=Math.round(Math.random()*c.sprite.frameCount),Game.map.add(c)}}}),Inventory={currentWeapon:null,coins:0,health:0,clear:function(){this.setWeapon(null),this.coins=0,this.health=12},addCoins:function(a){this.coins+=a},syncUi:function(){$("#coins .value").text(this.coins)},setWeapon:function(a){null!=Game.map&&null!=Game.map.player&&(Game.map.player.weapon=a),this.currentWeapon=a}};window.setInterval(Inventory.syncUi.bind(Inventory),250);var Loot=Entity.extend({causesCollision:!1,causesDamage:!1,receivesDamage:!1,isLoot:!0,isPickupable:!0,instantPickup:!0,init:function(){},pickUp:function(){Game.map.remove(this)},update:function(){this._super(),this.headBob=0,0!=this.velocityX&&(this.velocityX=MathHelper.lerp(this.velocityX,0,.1)),0!=this.velocityY&&(this.velocityY=MathHelper.lerp(this.velocityY,0,.1))}}),Coin=Loot.extend({init:function(){this._super(),this.height=16,this.width=16,this.sprite=new Animation("coin",16,16,15,10,!0),this.spriteShadow=null},pickUp:function(){this._super(),Sfx.play("coin_pickup.wav"),Inventory.addCoins(1)}}),Map=Class.extend({entities:[],paused:!1,id:null,loading:!1,loaded:!1,data:null,darkness:null,init:function(){this.clear(),this.loading=!1,this.loaded=!1,this.darkness=Gfx.load("darkness")},load:function(a,b){this.loading||(null==b&&(b=function(){}),this.id=a,this.loading=!0,console.info("[Map] Loading map",a),$.get("assets/maps/"+a+".json").success(function(a){this.data=a,this.processData(),this.loading=!1,this.loaded=!0,b(!0)}.bind(this)).error(function(a,c,d){console.error("[Map] A network error occurred while loading the map data.",c,d),this.loading=!1,this.loaded=!1,b(!1)}.bind(this)))},layers:null,tileset:null,height:0,width:0,heightPx:0,widthPx:0,tilesPerRow:0,mapScript:null,processData:function(){var a=this.data.tilesets[0].image;a=a.replace("../images/",""),a=a.replace(".png",""),this.height=this.data.height,this.width=this.data.width,this.heightPx=this.height*Settings.tileSize,this.widthPx=this.width*Settings.tileSize,this.tileset=Gfx.load(a),this.layers=this.data.layers,this.tilesPerRow=this.data.tilesets[0].imagewidth/Settings.tileSize,"undefined"==typeof this.data.properties&&(this.data.properties={});for(var b=0;b<this.layers.length;b++){var c=this.layers[b];"undefined"==typeof c.properties&&(c.properties={})}this.prepareBlockMap(),Camera.centerToMap();var d=new Player;this.configurePlayerSpawn(d),this.addPlayer(d),Music.stopAll();var e=this.data.properties;e.ambience&&!Settings.shutUpSoundscapes&&Music.loopSound(this.data.properties.ambience),null!=this.data.properties.script?(this.mapScript=new window.mapScripts[this.data.properties.script](this),this.mapScript.run()):this.mapScript=new MapScript(this),this.prepareMapSpawns()},configurePlayerSpawn:function(a){var b="initial";null!=Game.lastMapId&&(b=Game.lastMapId);var c=null;c="undefined"!=typeof this.data.properties["spawn_"+b]?this.data.properties["spawn_"+b]:"undefined"!=typeof this.data.properties.spawn_initial?this.data.properties.spawn_initial:"5, 5";var d=c.split(","),e=parseInt(d[0]),f=parseInt(d[1]),g=Direction.DOWN;d.length>=3&&(g=parseInt(d[2])),a.setCoord(e,f),a.direction=g},redeploy:function(){this.remove(this.player);var a=new Player;this.configurePlayerSpawn(a),this.addPlayer(a),this.mapScript.redeploy()},blockedTiles:[],blockedRects:[],teleRects:[],npcBlockedTiles:[],npcBlockedRects:[],prepareMapSpawns:function(){for(var a=this.layers.length,b=0;a>b;b++){var c=this.layers[b],d=c.properties.spawn;if(null!=d)for(var e=c.data.length,f=-1,g=0,h=0;e>h;h++){var i=c.data[h];if(f++,f>=this.width&&(g++,f=0),0!==i){var j=null;switch(d){default:console.warn("[Entity] Unknown spawn type, have a Goblin instead:",d);case"goblin":j=new Goblin;break;case"pot":j=new Pot;break;case"chest":j=new Chest;break;case"coin":j=new Coin}j.setCoord(f,g),Game.map.add(j)}}}},prepareBlockMap:function(){this.blockedTiles=[],this.blockedRects=[],this.teleRects=[],this.npcBlockedRects=[],this.npcBlockedTiles=[];for(var a=this.layers.length,b=0;a>b;b++)for(var c=this.layers[b],d=c.data.length,e=-1,f=0,g="1"==c.properties.blocked,h="1"==c.properties.npc_block,i=null!=c.properties.teleport?c.properties.teleport:null,j=0;d>j;j++){var k=c.data[j];if(e++,e>=this.width&&(f++,e=0),0!==k){var l={top:f*Settings.tileSize,left:e*Settings.tileSize,width:Settings.tileSize,height:Settings.tileSize};l.bottom=l.top+l.height,l.right=l.left+l.width,g&&(this.blockedTiles.push(e),this.blockedTiles.push(f),this.blockedRects.push(l)),h&&(this.npcBlockedTiles.push(e),this.npcBlockedTiles.push(f),this.npcBlockedRects.push(l)),null!=i&&(l.teleportTo=i,this.teleRects.push(l))}}},isCoordBlocked:function(a,b){for(var c=this.blockedTiles.length,d=0;c>d;d+=2){var e=this.blockedTiles[d],f=this.blockedTiles[d+1];if(a==e&&b==f)return!0}return!1},isRectBlocked:function(a,b,c){for(var d=this.blockedRects.length,e=0;d>e;e++)if(Utils.rectIntersects(a,this.blockedRects[e]))return!0;if(b)for(var f=this.npcBlockedRects.length,g=0;f>g;g++)if(Utils.rectIntersects(a,this.npcBlockedRects[g]))return!0;for(var h=this.entities.length,i=0;h>i;i++){var j=this.entities[i];if(j.causesCollision&&j!==c&&!j.causesDamage){var k=j.getRect();if(Utils.rectIntersects(a,k))return!0}}return!1},getEntitiesInRect:function(a,b){for(var c=[],d=this.entities.length,e=0;d>e;e++){var f=this.entities[e];if(f!==b){var g=f.getRect();Utils.rectIntersects(a,g)&&c.push(f)}}return c},getTeleport:function(a){for(var b=this.teleRects.length,c=0;b>c;c++)if(Utils.rectIntersects(a,this.teleRects[c]))return this.teleRects[c].teleportTo;return null},clear:function(){this.entities=[]},pause:function(){this.paused=!0,$("#hud").hide()},resume:function(){this.paused=!1,$("#hud").show()},player:null,add:function(a){this.entities.push(a)},addPlayer:function(a){this.player=a,this.add(a),Camera.followEntity(a,!0)},remove:function(a){var b=this.entities.indexOf(a);return b>0?(this.entities.splice(b,1),!0):!1},draw:function(a){this.loaded&&(this.drawBackground(a),this.drawEntities(a),a.drawImage(this.darkness,0,0,Canvas.canvas.width,Canvas.canvas.height,0,0,Canvas.canvas.width,Canvas.canvas.height))},drawBackground:function(a){for(var b=this.layers.length,c=0;b>c;c++){var d=this.layers[c],e=d.data.length,f=-1,g=0,h=Settings.drawCollisions&&"undefined"!=typeof d.properties&&"1"==d.properties.blocked;if(Settings.drawCollisions||d.visible)for(var i=0;e>i;i++){var j=d.data[i];if(f++,f>=this.width&&(g++,f=0),0!==j){j--;var k=Math.floor(j/this.tilesPerRow),l=k*Settings.tileSize,m=j*Settings.tileSize-k*this.tilesPerRow*Settings.tileSize,n=Camera.translateX(f*Settings.tileSize),o=Camera.translateY(g*Settings.tileSize);a.drawImage(this.tileset,m,l,Settings.tileSize,Settings.tileSize,n,o,Settings.tileSize,Settings.tileSize),h&&(a.beginPath(),a.rect(n,o,Settings.tileSize,Settings.tileSize),a.strokeStyle="#FCEB77",a.stroke(),a.closePath())}}}},drawEntities:function(a){for(var b=this.entities.length,c=0;b>c;c++){var d=this.entities[c];d!==this.player&&d.draw(a)}null!=this.player&&this.player.draw(a)},update:function(){if(!this.paused)for(var a=this.entities.length,b=0;a>b;b++)this.entities[b].update()}});window.mapScripts=[];var MapScript=Class.extend({map:null,init:function(a){this.map=a},run:function(){},redeploy:function(){}});window.mapScripts.epic_win=MapScript.extend({run:function(){Camera.trackingEntity=null,Camera.centerToMap(),Sfx.play("secret_success.wav"),Dialogue.prepare([{text:"You are the true hero!"},{text:"You win the game! You found the treasure room!"},{text:"Yeah, so, this is all I had time for."},{text:"Please forgive me."},{text:"Oh, and you get this kick ass sword for free with your win."}],function(){Camera.trackingEntity=Game.map.player}),Dialogue.show(),Inventory.setWeapon(new SwordSuper),Inventory.health=52,Game.map.player.healthCapacity=52,Game.map.player.healthValue=52,Game.map.player.syncHealthUi()}}),window.mapScripts.troll_intro_room=MapScript.extend({evilTroll:null,run:function(){Music.stopAll(),this.evilTroll=new Goblin,this.evilTroll.direction=Direction.UP,this.evilTroll.setCoord(9,7),this.evilTroll.killMode=!0,this.map.add(this.evilTroll),Camera.followEntity(this.evilTroll),Settings.skipIntroDialogue?this.afterIntro():(Dialogue.prepare([{text:"Who dares enter my lair!?",evil:!0},{text:"Begone with you!",evil:!0}],this.afterIntro.bind(this)),Dialogue.show())},afterIntro:function(){Camera.followEntity(this.map.player),Music.loopSound("dungeon_ambience.mp3")}}),window.mapScripts.wake_up=MapScript.extend({spawnedChest:!1,run:function(){this.spawnedChest=!1,Settings.skipIntroDialogue||(Dialogue.prepare([{text:"What..what is this?",player:!0},{text:"Where am I?",player:!0}]),Dialogue.show())},redeploy:function(){if(!this.spawnedChest){this.map.pause(),this.spawnedChest=!0;var a=new Chest;a.setCoord(9,2),a.direction=Direction.DOWN,a.open=function(){this._super(),Dialogue.prepare([{text:"It's a sword!",player:!0}]),Dialogue.show(),Inventory.setWeapon(new SwordBasic)},this.map.add(a),Camera.followEntity(a),Sfx.play("secret_success.wav"),window.setTimeout(function(){Camera.followEntity(this.map.player),Dialogue.prepare([{text:"Am I going crazy? What is going on here?",player:!0}]),Dialogue.show()}.bind(this),1e3)}}});var Weapon=Class.extend({damage:1,attackRadius:13,image:null,width:12,height:18,swordSway:0,swordSwayTimer:0,init:function(){this.damage=1,this.image=Gfx.load("sword_basic")},playSfx:function(){Sfx.play("sword_attack.wav")},update:function(a){0==a.velocityX&&0==a.velocityY?this.swordSway=0:(this.swordSwayTimer>0&&this.swordSwayTimer--,this.swordSwayTimer<=0&&(this.swordSwayTimer=30,this.swordSway=-1==this.swordSway?1:-1))},draw:function(a,b){b.drawImage(this.image,0,0,this.width,this.height,a.headBob+this.swordSway,-this.height+4,this.width,this.height)}}),SwordBasic=Weapon.extend({init:function(){this._super(),this.damage=1,this.image=Gfx.load("sword_basic")}}),SwordSuper=Weapon.extend({init:function(){this._super(),this.damage=3e3,this.image=Gfx.load("sword_super"),this.height=32}}),SwordTroll=Weapon.extend({init:function(){this._super(),this.damage=1,this.image=Gfx.load("sword_troll")}}),BootLogo={show:function(a){Sfx.play("burningtomato.wav"),$("#burningtomato").delay(500).fadeIn(500,function(){window.setTimeout(function(){$("#burningtomato").fadeOut(500,a)},1500)})}},Dialogue={running:!1,pages:null,currentPage:null,currentPageIdx:0,currentTickerIdx:0,typeDelay:0,fastMode:!1,dialogueCallback:null,prepare:function(a,b){this.pages=a,this.currentPage=a[0],this.currentPageIdx=0,this.currentTickerIdx=0,this.typeDelay=30,this.fastMode=!1,this.dialogueCallback=b,null==this.dialogueCallback&&(this.dialogueCallback=function(){})},show:function(){this.running||(Game.map.pause(),$(".dialogue").delay(100).fadeIn("fast").html(""),this.running=!0)
},hide:function(){this.running&&(Game.map.resume(),$(".dialogue").fadeOut("fast"),this.running=!1,this.dialogueCallback())},update:function(){if(this.running){this.typeDelay>0&&this.typeDelay--;var a=this.currentPage.text,b=a.length>this.currentTickerIdx;if(this.typeDelay<=0){if(b){this.currentTickerIdx++,Sfx.play("dialogue_tick.wav");var c=a.substr(0,this.currentTickerIdx),d=$(".dialogue"),e=$("<span />");d.html(""),e.text(c),e.appendTo(d),this.currentPage.player?(d.css("color","#5882FA"),d.css("text-align","center")):this.currentPage.evil?(d.css("color","#DF0101"),d.css("text-align","center")):(d.css("color","#fff"),d.css("text-align","left")),b=a.length>this.currentTickerIdx,b||$("<div />").addClass("next").text("Space").appendTo(d)}this.typeDelay=this.fastMode?1:4}if(this.fastMode=Keyboard.isKeyDown(KeyEvent.DOM_VK_SPACE)?!0:!1,!b&&Keyboard.wasKeyPressed(KeyEvent.DOM_VK_SPACE)){var f=this.currentPageIdx>=this.pages.length-1;f?this.hide():(this.currentTickerIdx=0,this.currentPage=this.pages[++this.currentPageIdx],this.typeDelay=10)}}}};